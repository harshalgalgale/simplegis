{% extends "base.html" %}


{% block title %} - Главная{% endblock %}

{% block extrahead %}
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU" type="text/javascript"></script>
<script type="text/javascript">
    {% block jquery %}
    $('#nav-main').addClass('active');
    {% endblock %}
    
    ymaps.ready(init);
    var myMap; 

       

    function init() { 

        // Инициализация карты
        myMap = new ymaps.Map ("map", {
            center: [ymaps.geolocation.latitude, ymaps.geolocation.longitude],
            zoom: 7,
            behaviors: ['default', 'scrollZoom']
        }); 
        

        // Отрисовка переданных из бд меток
        {% for placemark in placemarks %}
        var myPlacemark = new ymaps.Placemark([{{placemark.lat}},{{placemark.lon}}], {
            iconContent: "{{placemark.name}}", 
            balloonContent: "{{placemark.descr}}",   
        }, { balloonContentLayout: ymaps.templateLayoutFactory.createClass([
                    '<div id="menu" style="padding-right: 20px; padding-left: 20px">',
                        '<div style="display:none"><input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">',
                        '</div>',
                        '<div id="menu-list">',
                        '<h4>$[geometry.coordinates]</h4>',
                            '<label class="control-label">Название</label>',
                            '<input class="input-xlarge" maxlength="100" type="text" name="name" tabindex="1" required="required" placeholder="Название объекта" value="$[properties.iconContent]"/>',
                    
                            '<label class="control-label">Описание</label>',
                            '<textarea rows="3" maxlength="500" class="input-xlarge" name="description" tabindex="2" required="required" placeholder="Описание объекта">$[properties.balloonContent]</textarea>',
                        '</div>',
                        '<button type="submit" id="save" class="btn btn-small btn-primary">Сохранить</button>',
                        '<button type="delete" id="delete" class="btn btn-small" style="margin-left: 10px">Удалить</button>',
                    '</div>',

                    '<form id="add-image-form" method="POST" action="{% url sticktomap.views.add_image %}" enctype="multipart/form-data">',
                        '<div style="display:none"><input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">',
                        '</div>',
                        '<div style="display:none">',
                            
                                '<input type="hidden" id="id" value="$[properties.id]">',
                                '<input type="file" class="file" id="upload-image" />',
                                '<button type="submit" id="image" class="btn btn-small" style="margin-left: 10px">Отправить</button>',
                             
                        '</div>',
                    '</form>'].join(' '), {
                build: function (e) {
                    this.constructor.superclass.build.call(this);

                    geoObject = this.geoObject = this.getData().geoObject;
                    


                    
                    $('#save').bind('click', $.proxy(this.onSave,this));
                    $('#delete').bind('click', $.proxy(this.onDelete,this));
                    $('#image').bind('click', $.proxy(this.onImage,this));

                },
                clear: function () {
                    $('#save').unbind('click');
                    $('#delete').unbind('click');
                    this.constructor.superclass.clear.call(this);
                },
                onDelete: function () {
                    $.post("{% url sticktomap.views.delete %}", {
                            id: geoObject.properties.get('id')
                        }, function(data){
                                alert("Метка удалена из базы данных.");
                                myMap.geoObjects.remove(geoObject);
                        });
                },
                onSave: function () {
                    if (!$('input[name="name"]').val() || !$('textarea[name="description"]').val()) {
                        alert("Поля должны быть заполнены.");
                    }
                    else {
                        geoObject.properties.set({
                            iconContent: $('input[name="name"]').val(),
                            balloonContent: $('textarea[name="description"]').val(),                       
                        });


                        var geoobjectString = $('input[name="name"]').val() + ' ' + $('textarea[name="description"]').val() + ' ' + geoObject.properties.get('id');

                        $.post("{% url sticktomap.views.update %}", {
                            geoobjectString: geoobjectString
                            }, function(data){
                                alert("Метка сохранена в базе данных.");
                        });
                    }
                      
                },
                onImage: function () {
                    $('#add-image-form').ajaxForm();
                } 
            }
        ),
        preset: 'twirl#blueStretchyIcon', 

        }
        );

        myPlacemark.properties.set({ id: {{placemark.id}} });

        myMap.geoObjects.add(myPlacemark);
        {% endfor %}


        // ajax csrf token handling
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

        myMap.events.add('click', function (e) {
            if (!myMap.balloon.isOpen()) {

                var coords = e.get('coordPosition');
                myMap.balloon.open(coords, {                        
                    contentBody:   ['<div id="menu">',
                                    '<div style="display:none"><input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"></div>',
                                        '<div id="menu_list">',
                                            '<label>Название</label>',
                                            ' <input type="text" maxlength="100" class="input-xlarge" name="icon_text" required="required" placeholder="Название объекта" /><br />',
                                            '<label>Описание</label>',
                                            '<textarea rows="3" maxlength="500" class="input-xlarge" name="balloon_text" tabindex="2" required="required" placeholder="Описание объекта"></textarea>',
                                        '</div>',
                                        '<button type="submit" class="btn btn-success">Сохранить</button>',
                                    '</div>'
                ].join(' ')});
                     
                var myPlacemark = new ymaps.Placemark(coords);
 
                //Сохраняем данные из формы     
                $('#menu button[type="submit"]').click(function () {
                    var iconText = $('input[name="icon_text"]').val(),
                        balloonText = $('textarea[name="balloon_text"]').val();
                    if (!$('input[name="icon_text"]').val() || !$('textarea[name="balloon_text"]').val()) {
                        alert("Поля должны быть заполнены.");
                    }
                    else {                
                        //Добавляем метку на карту  
                        myMap.geoObjects.add(myPlacemark);

                        //Изменяем свойства метки и балуна
                        myPlacemark.properties.set({
                            iconContent: iconText,
                            balloonContent: balloonText,                       
                        });
                        
                        var placemarkString = iconText + ' ' + balloonText + ' ' + coords[0].toPrecision(6) + ' ' + coords[1].toPrecision(6); 

                        $.post("{% url sticktomap.views.save %}", {
                            placemarkString: placemarkString
                            }, function(data){
                                alert("Метка добавлена в базу данных.");
                                myPlacemark.properties.set({ id: data["id"] });
                        });
                    
                        //Закрываем балун
                        myMap.balloon.close(); 
                    }
                });       
                
            } else {
                myMap.balloon.close();
            }
        });

        

        

        
    }


    function BuildRoute() {
        var point = [],
        i = 0,
        p,
        it = myMap.geoObjects.getIterator(); 

        while (p = it.getNext()) {
            point[i] = p.geometry.getCoordinates();
            i++;
        }
    
        ymaps.route(point, {
            mapStateAutoApply: true
        }).then(function (r) {
            route = r;
            route.getPaths().options.set({
            // в балуне выводим только информацию о времени движения с учетом пробок
            balloonContenBodyLayout: ymaps.templateLayoutFactory.createClass('$[properties.humanJamsTime]'),
            // можно выставить настройки графики маршруту
            strokeColor: '0000ffff',
            opacity: 0.9});
            
            var moveList = '</br>Трогаемся.</br>',
            way,
            segments;
            // Получаем массив путей.
            for (var i = 0; i < route.getPaths().getLength(); i++) {
                way = route.getPaths().get(i);
                segments = way.getSegments();
                for (var j = 0; j < segments.length; j++) {
                    var street = segments[j].getStreet();
                    moveList += ('Едем ' + segments[j].getHumanAction() + (street ? ' на ' + street : '') + ', проезжаем ' + segments[j].getLength() + ' м.');
                    moveList += '</br>'
                }
            }
            moveList += 'Останавливаемся.';
            // Выводим маршрутный лист.
            $('#info').append(moveList);
            
            
            myMap.geoObjects.add(route);

        }, function (error) {
            alert('Возникла ошибка: ' + error.message);
        })
    } 

    

    function ResetRoute() {
        myMap.geoObjects.remove(route);
        $('#info').text("");
        myMap.setCenter([ymaps.geolocation.latitude, ymaps.geolocation.longitude], 7);
    }



</script>
{% endblock %}


{% block content %}
<div class="container-fluid">
<div class="row-fluid">
    <div class="span8">
        <div id="map" style="width: 750px; height: 600px"></div>
    </div>
    <div class="span4">
        <button id="build" class="btn btn-success" onclick="BuildRoute()" >Построить маршрут</button>
        <button id="reset" class="btn btn-cancel" onclick="ResetRoute()" >Очистить</button>
        <div id="info" style="width: 400px; height: 600px"></div>    
    </div>
</div>
</div>

{% endblock %}
